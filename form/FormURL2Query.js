"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const FormController_1 = require("./FormController");
console.log("in FormURL2Query");
function turnURLStemsIntoLookupObject(req, next) {
    console.log(req.params.ClientIdentifierType);
    console.log(req.params.ClientIdentifierValue);
    let lookup = FormController_1.externalIdLookup(req.params.ClientIdentifierType, req.params.ClientIdentifierValue);
    if (req.params.AccountSequenceNumber)
        lookup.AccountSequenceNumber = parseInt(req.params.AccountSequenceNumber);
    if (req.params.RoleTypeShortDecode)
        lookup.RoleTypeCode = FormController_1.codeLookup(req.params.RoleTypeShortDecode);
    if (req.params.PeriodStartDt)
        lookup.PeriodStartDt = req.params.PeriodStartDt;
    if (req.params.FormTypeMung) {
        if (!req.params.FormTypeMung.toLowerCase().endsWith("form"))
            next(new Error("Invalid FormType Stem"));
        lookup.FormType = req.params.FormTypeMung.slice(0, -4);
    }
    if (req.params.TransactionId)
        lookup.TransactionId = parseInt(req.params.TransactionId);
    if (req.params._id)
        lookup.TransactionId = parseInt(req.params._id);
    let filterProperty = req.query.filter;
    console.log(`filterProperty: ${filterProperty}`);
    //url filter should look like: PeriodBeginDate=2018-12-31,PeriodEndDate=2019-03-31
    //want it to look like: {  ClientInternalId: 12345 ,...blah..., $and: [{ PeriodStartDt: { $gt: "2018-12-31" } }, { PeriodStartDt: { $lt: "2019-01-02" } }] }
    let periodFilter = (filterProperty || "").split(",");
    let periodBeginFilter = (periodFilter[0] || "PeriodBeginDate=2000-01-01").split("=")[1] || "2000-01-01";
    let periodEndFilter = (periodFilter[1] || "PeriodEndDate=9999-31-12").split("=")[1] || "9999-31-12";
    let filter = [{ PeriodStartDt: { $gt: "2000-01-10" } }, { PeriodStartDt: { $lt: "9999-31-12" } }];
    filter[0].PeriodStartDt.$gt = periodBeginFilter;
    filter[1].PeriodStartDt.$lt = periodEndFilter;
    // todo: can't get dates to work  
    // lookup.$and = filter;
    // tried: https://stackoverflow.com/questions/19819870/date-query-with-isodate-in-mongodb-doesnt-seem-to-work
    // lookup = {PeriodStartDt:{$gte:"2019-01-01"}}
    // lookup = {PeriodStartDt: {"$gte" : new Date("2013-10-01").toISOString() } };
    // lookup = {ClientInternalId:12345,AccountSequenceNumber:1,RoleTypeCode:5,FormType:"myFT6",TransactionId:1122330};
    // lookup = {ClientInternalId:12345,AccountSequenceNumber:1,RoleTypeCode:5,FormType:"myFT6",TransactionId:1122330,$and:[{PeriodStartDt:{$gt:"2018-12-31"}},{PeriodStartDt:{$lt:"2019-03-31"}}]};
    // lookup = {$and:[{PeriodStartDt:{$gt:"2018-12-31"}}]};
    // this one does work because its not a date: lookup.AccountSequenceNumber = {$gt: 0}
    //todo: add form line item filter properties...
    lookup = addOptimisticLockingConstraint(lookup, req.body);
    let x = JSON.stringify(lookup);
    console.log(`Looking up database with: ${JSON.stringify(lookup)}`);
    return lookup;
}
exports.turnURLStemsIntoLookupObject = turnURLStemsIntoLookupObject;
// add DT/TM_Update for optimistic locking check (double update will result in "not found", 
// which may result in an insert with duplicate Transaction_Id, hence unique index violation)
function addOptimisticLockingConstraint(lookup, tobeForm) {
    if (tobeForm.DT_Update) {
        lookup.DT_Update = tobeForm.DT_Update;
        lookup.TM_Update = tobeForm.TM_Update;
    }
    return lookup;
}
exports.addOptimisticLockingConstraint = addOptimisticLockingConstraint;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRm9ybVVSTDJRdWVyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkZvcm1VUkwyUXVlcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxxREFBZ0U7QUFDaEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBY2hDLFNBQWdCLDRCQUE0QixDQUFDLEdBQW9CLEVBQUUsSUFBMEI7SUFDekYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDN0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFDOUMsSUFBSSxNQUFNLEdBQWtCLGlDQUFnQixDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0lBRWhILElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUI7UUFDaEMsTUFBTSxDQUFDLHFCQUFxQixHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFFOUUsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLG1CQUFtQjtRQUM5QixNQUFNLENBQUMsWUFBWSxHQUFHLDJCQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBRXJFLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxhQUFhO1FBQ3hCLE1BQU0sQ0FBQyxhQUFhLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7SUFFcEQsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRTtRQUN6QixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUN2RCxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzFEO0lBRUQsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLGFBQWE7UUFDeEIsTUFBTSxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUU5RCxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRztRQUNkLE1BQU0sQ0FBQyxhQUFhLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFcEQsSUFBSSxjQUFjLEdBQVcsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFDOUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsY0FBYyxFQUFFLENBQUMsQ0FBQztJQUNqRCxrRkFBa0Y7SUFDbEYsNEpBQTRKO0lBQzVKLElBQUksWUFBWSxHQUFHLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNyRCxJQUFJLGlCQUFpQixHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLDRCQUE0QixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFlBQVksQ0FBQztJQUN4RyxJQUFJLGVBQWUsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSwwQkFBMEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxZQUFZLENBQUM7SUFDcEcsSUFBSSxNQUFNLEdBQUcsQ0FBQyxFQUFFLGFBQWEsRUFBRSxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsR0FBRyxpQkFBaUIsQ0FBQztJQUNoRCxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsR0FBRyxlQUFlLENBQUM7SUFDOUMsa0NBQWtDO0lBQ2xDLHdCQUF3QjtJQUN4Qiw2R0FBNkc7SUFDN0csK0NBQStDO0lBQy9DLCtFQUErRTtJQUMvRSxtSEFBbUg7SUFDbkgsZ01BQWdNO0lBQ2hNLHdEQUF3RDtJQUN4RCxxRkFBcUY7SUFDckYsK0NBQStDO0lBRS9DLE1BQU0sR0FBRyw4QkFBOEIsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFELElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFbkUsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQXJERCxvRUFxREM7QUFHRCw0RkFBNEY7QUFDNUYsNkZBQTZGO0FBQzdGLFNBQWdCLDhCQUE4QixDQUFDLE1BQXFCLEVBQUUsUUFBYTtJQUNqRixJQUFJLFFBQVEsQ0FBQyxTQUFTLEVBQUM7UUFDbkIsTUFBTSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDO1FBQ3RDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQztLQUN6QztJQUNELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFORCx3RUFNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBleHRlcm5hbElkTG9va3VwLCBjb2RlTG9va3VwIH0gZnJvbSAnLi9Gb3JtQ29udHJvbGxlcic7XG5jb25zb2xlLmxvZyhcImluIEZvcm1VUkwyUXVlcnlcIik7XG5cbmV4cG9ydCBpbnRlcmZhY2UgZm9ybVF1ZXJ5VHlwZSB7XG4gICAgQ2xpZW50SW50ZXJuYWxJZD86IG51bWJlcjtcbiAgICBBY2NvdW50U2VxdWVuY2VOdW1iZXI/OiBhbnk7XG4gICAgUm9sZVR5cGVDb2RlPzogbnVtYmVyO1xuICAgIFBlcmlvZFN0YXJ0RHQ/OiBhbnk7XG4gICAgRm9ybVR5cGU/OiBzdHJpbmc7XG4gICAgVHJhbnNhY3Rpb25JZD86IG51bWJlcjtcbiAgICBEVF9VcGRhdGU/OiBzdHJpbmcsXG4gICAgVE1fVXBkYXRlPzogc3RyaW5nLFxuICAgIF9pZD86IGFueTtcbiAgICAkYW5kPzogb2JqZWN0O1xufVxuZXhwb3J0IGZ1bmN0aW9uIHR1cm5VUkxTdGVtc0ludG9Mb29rdXBPYmplY3QocmVxOiBleHByZXNzLlJlcXVlc3QsIG5leHQ6IGV4cHJlc3MuTmV4dEZ1bmN0aW9uKTogZm9ybVF1ZXJ5VHlwZSB7XG4gICAgY29uc29sZS5sb2cocmVxLnBhcmFtcy5DbGllbnRJZGVudGlmaWVyVHlwZSk7XG4gICAgY29uc29sZS5sb2cocmVxLnBhcmFtcy5DbGllbnRJZGVudGlmaWVyVmFsdWUpO1xuICAgIGxldCBsb29rdXA6IGZvcm1RdWVyeVR5cGUgPSBleHRlcm5hbElkTG9va3VwKHJlcS5wYXJhbXMuQ2xpZW50SWRlbnRpZmllclR5cGUsIHJlcS5wYXJhbXMuQ2xpZW50SWRlbnRpZmllclZhbHVlKTtcbiAgICBcbiAgICBpZiAocmVxLnBhcmFtcy5BY2NvdW50U2VxdWVuY2VOdW1iZXIpXG4gICAgICAgIGxvb2t1cC5BY2NvdW50U2VxdWVuY2VOdW1iZXIgPSBwYXJzZUludChyZXEucGFyYW1zLkFjY291bnRTZXF1ZW5jZU51bWJlcik7XG4gICAgXG4gICAgaWYgKHJlcS5wYXJhbXMuUm9sZVR5cGVTaG9ydERlY29kZSlcbiAgICAgICAgbG9va3VwLlJvbGVUeXBlQ29kZSA9IGNvZGVMb29rdXAocmVxLnBhcmFtcy5Sb2xlVHlwZVNob3J0RGVjb2RlKTtcbiAgICBcbiAgICBpZiAocmVxLnBhcmFtcy5QZXJpb2RTdGFydER0KVxuICAgICAgICBsb29rdXAuUGVyaW9kU3RhcnREdCA9IHJlcS5wYXJhbXMuUGVyaW9kU3RhcnREdDtcbiAgICBcbiAgICBpZiAocmVxLnBhcmFtcy5Gb3JtVHlwZU11bmcpIHtcbiAgICAgICAgaWYgKCFyZXEucGFyYW1zLkZvcm1UeXBlTXVuZy50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKFwiZm9ybVwiKSlcbiAgICAgICAgICAgIG5leHQobmV3IEVycm9yKFwiSW52YWxpZCBGb3JtVHlwZSBTdGVtXCIpKTtcbiAgICAgICAgbG9va3VwLkZvcm1UeXBlID0gcmVxLnBhcmFtcy5Gb3JtVHlwZU11bmcuc2xpY2UoMCwgLTQpO1xuICAgIH1cbiAgICBcbiAgICBpZiAocmVxLnBhcmFtcy5UcmFuc2FjdGlvbklkKVxuICAgICAgICBsb29rdXAuVHJhbnNhY3Rpb25JZCA9IHBhcnNlSW50KHJlcS5wYXJhbXMuVHJhbnNhY3Rpb25JZCk7XG4gICAgXG4gICAgaWYgKHJlcS5wYXJhbXMuX2lkKVxuICAgICAgICBsb29rdXAuVHJhbnNhY3Rpb25JZCA9IHBhcnNlSW50KHJlcS5wYXJhbXMuX2lkKTsgIFxuICAgIFxuICAgIGxldCBmaWx0ZXJQcm9wZXJ0eTogc3RyaW5nID0gcmVxLnF1ZXJ5LmZpbHRlcjtcbiAgICBjb25zb2xlLmxvZyhgZmlsdGVyUHJvcGVydHk6ICR7ZmlsdGVyUHJvcGVydHl9YCk7XG4gICAgLy91cmwgZmlsdGVyIHNob3VsZCBsb29rIGxpa2U6IFBlcmlvZEJlZ2luRGF0ZT0yMDE4LTEyLTMxLFBlcmlvZEVuZERhdGU9MjAxOS0wMy0zMVxuICAgIC8vd2FudCBpdCB0byBsb29rIGxpa2U6IHsgIENsaWVudEludGVybmFsSWQ6IDEyMzQ1ICwuLi5ibGFoLi4uLCAkYW5kOiBbeyBQZXJpb2RTdGFydER0OiB7ICRndDogXCIyMDE4LTEyLTMxXCIgfSB9LCB7IFBlcmlvZFN0YXJ0RHQ6IHsgJGx0OiBcIjIwMTktMDEtMDJcIiB9IH1dIH1cbiAgICBsZXQgcGVyaW9kRmlsdGVyID0gKGZpbHRlclByb3BlcnR5IHx8IFwiXCIpLnNwbGl0KFwiLFwiKTtcbiAgICBsZXQgcGVyaW9kQmVnaW5GaWx0ZXIgPSAocGVyaW9kRmlsdGVyWzBdIHx8IFwiUGVyaW9kQmVnaW5EYXRlPTIwMDAtMDEtMDFcIikuc3BsaXQoXCI9XCIpWzFdIHx8IFwiMjAwMC0wMS0wMVwiO1xuICAgIGxldCBwZXJpb2RFbmRGaWx0ZXIgPSAocGVyaW9kRmlsdGVyWzFdIHx8IFwiUGVyaW9kRW5kRGF0ZT05OTk5LTMxLTEyXCIpLnNwbGl0KFwiPVwiKVsxXSB8fCBcIjk5OTktMzEtMTJcIjtcbiAgICBsZXQgZmlsdGVyID0gW3sgUGVyaW9kU3RhcnREdDogeyAkZ3Q6IFwiMjAwMC0wMS0xMFwiIH0gfSwgeyBQZXJpb2RTdGFydER0OiB7ICRsdDogXCI5OTk5LTMxLTEyXCIgfSB9XTtcbiAgICBmaWx0ZXJbMF0uUGVyaW9kU3RhcnREdC4kZ3QgPSBwZXJpb2RCZWdpbkZpbHRlcjtcbiAgICBmaWx0ZXJbMV0uUGVyaW9kU3RhcnREdC4kbHQgPSBwZXJpb2RFbmRGaWx0ZXI7XG4gICAgLy8gdG9kbzogY2FuJ3QgZ2V0IGRhdGVzIHRvIHdvcmsgIFxuICAgIC8vIGxvb2t1cC4kYW5kID0gZmlsdGVyO1xuICAgIC8vIHRyaWVkOiBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xOTgxOTg3MC9kYXRlLXF1ZXJ5LXdpdGgtaXNvZGF0ZS1pbi1tb25nb2RiLWRvZXNudC1zZWVtLXRvLXdvcmtcbiAgICAvLyBsb29rdXAgPSB7UGVyaW9kU3RhcnREdDp7JGd0ZTpcIjIwMTktMDEtMDFcIn19XG4gICAgLy8gbG9va3VwID0ge1BlcmlvZFN0YXJ0RHQ6IHtcIiRndGVcIiA6IG5ldyBEYXRlKFwiMjAxMy0xMC0wMVwiKS50b0lTT1N0cmluZygpIH0gfTtcbiAgICAvLyBsb29rdXAgPSB7Q2xpZW50SW50ZXJuYWxJZDoxMjM0NSxBY2NvdW50U2VxdWVuY2VOdW1iZXI6MSxSb2xlVHlwZUNvZGU6NSxGb3JtVHlwZTpcIm15RlQ2XCIsVHJhbnNhY3Rpb25JZDoxMTIyMzMwfTtcbiAgICAvLyBsb29rdXAgPSB7Q2xpZW50SW50ZXJuYWxJZDoxMjM0NSxBY2NvdW50U2VxdWVuY2VOdW1iZXI6MSxSb2xlVHlwZUNvZGU6NSxGb3JtVHlwZTpcIm15RlQ2XCIsVHJhbnNhY3Rpb25JZDoxMTIyMzMwLCRhbmQ6W3tQZXJpb2RTdGFydER0OnskZ3Q6XCIyMDE4LTEyLTMxXCJ9fSx7UGVyaW9kU3RhcnREdDp7JGx0OlwiMjAxOS0wMy0zMVwifX1dfTtcbiAgICAvLyBsb29rdXAgPSB7JGFuZDpbe1BlcmlvZFN0YXJ0RHQ6eyRndDpcIjIwMTgtMTItMzFcIn19XX07XG4gICAgLy8gdGhpcyBvbmUgZG9lcyB3b3JrIGJlY2F1c2UgaXRzIG5vdCBhIGRhdGU6IGxvb2t1cC5BY2NvdW50U2VxdWVuY2VOdW1iZXIgPSB7JGd0OiAwfVxuICAgIC8vdG9kbzogYWRkIGZvcm0gbGluZSBpdGVtIGZpbHRlciBwcm9wZXJ0aWVzLi4uXG4gICAgXG4gICAgbG9va3VwID0gYWRkT3B0aW1pc3RpY0xvY2tpbmdDb25zdHJhaW50KGxvb2t1cCwgcmVxLmJvZHkpO1xuICAgIFxuICAgIGxldCB4ID0gSlNPTi5zdHJpbmdpZnkobG9va3VwKTtcbiAgICBjb25zb2xlLmxvZyhgTG9va2luZyB1cCBkYXRhYmFzZSB3aXRoOiAke0pTT04uc3RyaW5naWZ5KGxvb2t1cCl9YCk7XG5cbiAgICByZXR1cm4gbG9va3VwO1xufVxuXG5cbi8vIGFkZCBEVC9UTV9VcGRhdGUgZm9yIG9wdGltaXN0aWMgbG9ja2luZyBjaGVjayAoZG91YmxlIHVwZGF0ZSB3aWxsIHJlc3VsdCBpbiBcIm5vdCBmb3VuZFwiLCBcbi8vIHdoaWNoIG1heSByZXN1bHQgaW4gYW4gaW5zZXJ0IHdpdGggZHVwbGljYXRlIFRyYW5zYWN0aW9uX0lkLCBoZW5jZSB1bmlxdWUgaW5kZXggdmlvbGF0aW9uKVxuZXhwb3J0IGZ1bmN0aW9uIGFkZE9wdGltaXN0aWNMb2NraW5nQ29uc3RyYWludChsb29rdXA6IGZvcm1RdWVyeVR5cGUsIHRvYmVGb3JtOiBhbnkpIHtcbiAgaWYgKHRvYmVGb3JtLkRUX1VwZGF0ZSl7XG4gICAgICBsb29rdXAuRFRfVXBkYXRlID0gdG9iZUZvcm0uRFRfVXBkYXRlO1xuICAgICAgbG9va3VwLlRNX1VwZGF0ZSA9IHRvYmVGb3JtLlRNX1VwZGF0ZTtcbiAgfVxuICByZXR1cm4gbG9va3VwO1xufVxuIl19